{% extends "admin/base.html" %}

{% block title %}首页配置 - AI-CMS{% endblock %}

{% block head %}
<style>
    .section-card {
        transition: all 0.3s ease;
        cursor: move;
    }
    .section-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .section-card.dragging {
        opacity: 0.5;
        transform: scale(0.95);
    }
    .sortable-ghost {
        opacity: 0.4;
    }
    .drag-handle {
        cursor: move;
        color: #adb5bd;
    }
    .drag-handle:hover {
        color: #495057;
    }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-home me-2"></i>首页配置</h1>
        <a href="{{ url_for('index') }}" target="_blank" class="btn btn-outline-primary">
            <i class="fas fa-external-link-alt me-2"></i>预览首页
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>布局配置</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">拖拽下方区块调整首页布局顺序，勾选控制是否显示</p>

                    <div id="sections-list">
                        <!-- Sections will be loaded here -->
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-lg w-100" onclick="saveConfig()">
                            <i class="fas fa-save me-2"></i>保存配置
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-palette me-2"></i>Hero区域设置</h5>
                </div>
                <div class="card-body">
                    <div id="hero-config">
                        <div class="mb-3">
                            <label class="form-label">主标题</label>
                            <input type="text" id="hero-title" class="form-control" placeholder="欢迎来到AI-CMS">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">副标题</label>
                            <textarea id="hero-subtitle" class="form-control" rows="3" placeholder="智能内容管理系统，让创作更简单"></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="hero-show-buttons" checked>
                            <label class="form-check-label">显示按钮</label>
                        </div>
                        <div class="button-configs">
                            <div class="mb-3">
                                <label class="form-label">按钮1文本</label>
                                <input type="text" id="hero-btn1-text" class="form-control" placeholder="阅读文章">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">按钮1链接</label>
                                <input type="text" id="hero-btn1-link" class="form-control" placeholder="/articles">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">按钮2文本</label>
                                <input type="text" id="hero-btn2-text" class="form-control" placeholder="观看视频">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">按钮2链接</label>
                                <input type="text" id="hero-btn2-link" class="form-control" placeholder="/videos">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    let homepageConfig = null;
    let sectionsOrder = [];

    // 页面加载时获取配置
    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
    });

    function loadConfig() {
        fetch('/api/admin/homepage-config')
            .then(response => response.json())
            .then(data => {
                homepageConfig = data;
                renderConfig();
            })
            .catch(error => {
                console.error('Error loading config:', error);
                alert('加载配置失败');
            });
    }

    function renderConfig() {
        if (!homepageConfig) return;

        const config = homepageConfig.config;
        const sections = config.sections || [];

        // 渲染Hero配置
        const hero = config.hero || {};
        document.getElementById('hero-title').value = hero.title || '';
        document.getElementById('hero-subtitle').value = hero.subtitle || '';
        document.getElementById('hero-show-buttons').checked = hero.show_buttons !== false;
        document.getElementById('hero-btn1-text').value = hero.button1_text || '';
        document.getElementById('hero-btn1-link').value = hero.button1_link || '';
        document.getElementById('hero-btn2-text').value = hero.button2_text || '';
        document.getElementById('hero-btn2-link').value = hero.button2_link || '';

        // 渲染Sections列表
        const sectionsList = document.getElementById('sections-list');
        sectionsList.innerHTML = '';

        sections.forEach((section, index) => {
            const sectionCard = createSectionCard(section, index);
            sectionsList.appendChild(sectionCard);
        });

        // 初始化拖拽排序
        initSortable();
    }

    function createSectionCard(section, index) {
        const card = document.createElement('div');
        card.className = 'card section-card mb-3';
        card.dataset.sectionId = index;

        const sectionType = getSectionTypeLabel(section.type);
        const sectionIcon = getSectionIcon(section.type);

        card.innerHTML = `
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="drag-handle fas fa-grip-vertical fa-lg me-3"></i>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="${sectionIcon} me-2"></i>
                            <h6 class="mb-0">${sectionType}</h6>
                        </div>
                        ${section.type !== 'hero' ? `
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control form-control-sm"
                                           placeholder="区域标题" value="${section.title || ''}"
                                           data-field="title">
                                </div>
                                <div class="col-md-6">
                                    <input type="number" class="form-control form-control-sm"
                                           placeholder="显示数量" value="${section.limit || 6}"
                                           data-field="limit" min="1" max="20">
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="ms-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" ${section.visible !== false ? 'checked' : ''}
                               data-field="visible">
                    </div>
                </div>
            </div>
        `;

        return card;
    }

    function getSectionTypeLabel(type) {
        const labels = {
            'hero': 'Hero区域',
            'articles': '文章区域',
            'videos': '视频区域',
            'images': '图片区域'
        };
        return labels[type] || type;
    }

    function getSectionIcon(type) {
        const icons = {
            'hero': 'fas fa-bullhorn',
            'articles': 'fas fa-newspaper',
            'videos': 'fas fa-video',
            'images': 'fas fa-images'
        };
        return icons[type] || 'fas fa-square';
    }

    function initSortable() {
        const sectionsList = document.getElementById('sections-list');
        new Sortable(sectionsList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'dragging',
            handle: '.drag-handle',
            onEnd: function(evt) {
                updateSectionsOrder();
            }
        });

        // 为所有输入框添加事件监听器
        sectionsList.querySelectorAll('input, textarea, select').forEach(input => {
            input.addEventListener('change', updateSectionData);
        });
    }

    function updateSectionsOrder() {
        const cards = document.querySelectorAll('.section-card');
        sectionsOrder = Array.from(cards).map(card => card.dataset.sectionId);
    }

    function updateSectionData(event) {
        const card = event.target.closest('.section-card');
        const sectionId = parseInt(card.dataset.sectionId);
        const field = event.target.dataset.field;
        const value = event.target.type === 'checkbox' ? event.target.checked : event.target.value;

        if (homepageConfig.config.sections[sectionId]) {
            homepageConfig.config.sections[sectionId][field] = value;
        }
    }

    function saveConfig() {
        // 收集Hero配置
        const heroConfig = {
            title: document.getElementById('hero-title').value,
            subtitle: document.getElementById('hero-subtitle').value,
            show_buttons: document.getElementById('hero-show-buttons').checked,
            button1_text: document.getElementById('hero-btn1-text').value,
            button1_link: document.getElementById('hero-btn1-link').value,
            button2_text: document.getElementById('hero-btn2-text').value,
            button2_link: document.getElementById('hero-btn2-link').value
        };

        // 更新sections的顺序
        if (sectionsOrder.length > 0) {
            const newSections = [];
            sectionsOrder.forEach((oldIndex, newIndex) => {
                const section = homepageConfig.config.sections[oldIndex];
                section.order = newIndex;
                newSections.push(section);
            });
            homepageConfig.config.sections = newSections;
        }

        homepageConfig.config.hero = heroConfig;

        // 发送保存请求
        fetch('/api/admin/homepage-config', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                config: homepageConfig.config,
                enabled: homepageConfig.enabled
            })
        })
        .then(response => response.json())
        .then(data => {
            alert('✅ 配置保存成功！');
        })
        .catch(error => {
            console.error('Error saving config:', error);
            alert('❌ 保存失败，请重试');
        });
    }
</script>
{% endblock %}
