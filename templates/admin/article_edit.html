{% extends "admin/base.html" %}

{% block page_title %} {% if article %}ç¼–è¾‘æ–‡ç« {% else %}æ–°å»ºæ–‡ç« {% endif %} {% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <form method="post" id="articleForm">
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label class="form-label">æ–‡ç« æ ‡é¢˜ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-lg" name="title"
                               value="{{ article.title if article else '' }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ–‡ç« æ‘˜è¦</label>
                        <textarea class="form-control" name="excerpt" rows="3"
                                  placeholder="è¯·è¾“å…¥æ–‡ç« æ‘˜è¦">{{ article.excerpt if article else '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-image me-2"></i>å°é¢å›¾ç‰‡
                            <span class="badge bg-info ms-2">æ¨è</span>
                        </label>
                        <input type="hidden" name="cover_image" id="coverImageInput" value="{{ article.cover_image if article else '' }}">
                        <div class="cover-image-selector">
                            <!-- å½“å‰å°é¢å›¾ç‰‡é¢„è§ˆ -->
                            {% if article and article.cover_image %}
                            <div class="current-cover mb-3" id="currentCover">
                                <img src="{% if article.cover_image.startswith('http') %}{{ article.cover_image }}{% else %}/static/{{ article.cover_image }}{% endif %}" alt="å½“å‰å°é¢" class="img-thumbnail" style="max-height: 200px;">
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCoverImage()">
                                        <i class="fas fa-times me-1"></i>ç§»é™¤å°é¢
                                    </button>
                                </div>
                            </div>
                            {% endif %}

                            <!-- é€‰æ‹©æŒ‰é’® -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary" onclick="showCoverImagePicker()">
                                    <i class="fas fa-images me-2"></i>ä»å›¾ç‰‡åº“é€‰æ‹©
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="uploadNewCoverImage()">
                                    <i class="fas fa-upload me-2"></i>ä¸Šä¼ æ–°å°é¢
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            å°é¢å›¾ç‰‡å°†åœ¨æ–‡ç« åˆ—è¡¨å’Œé¦–é¡µä»¥ç¼©ç•¥å›¾å½¢å¼æ˜¾ç¤ºï¼Œå»ºè®®å°ºå¯¸ 1200Ã—630 åƒç´ 
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ–‡ç« å†…å®¹ <span class="text-danger">*</span></label>
                        <div id="editor" style="height: 400px;">
                            {{ article.content|safe if article else '' }}
                        </div>
                        <input type="hidden" name="content" id="contentInput">
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-lightbulb me-2"></i>å›¾ç‰‡ä½¿ç”¨å»ºè®®</h6>
                            <div class="small text-muted">
                                <p class="mb-2"><strong>âœ… æ¨èåšæ³•ï¼š</strong></p>
                                <ul class="mb-2">
                                    <li>å¤§å›¾ç‰‡ä¸Šä¼ åˆ°"å›¾ç‰‡ç®¡ç†"</li>
                                    <li>æ–‡ç« ä¸­æ’å…¥å›¾ç‰‡é“¾æ¥</li>
                                    <li>Base64å›¾ç‰‡ < 500KB</li>
                                    <li>æ–‡ç« æ€»å›¾ç‰‡ < 2MB</li>
                                </ul>
                                <p class="mb-0"><strong>âŒ é¿å…ï¼š</strong></p>
                                <ul class="mb-0">
                                    <li>ç›´æ¥ç²˜è´´å¤§å›¾ç‰‡</li>
                                    <li>å¤šä¸ªBase64å¤§å›¾</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">å‘å¸ƒè®¾ç½®</h6>

                            <div class="mb-3">
                                <label class="form-label">çŠ¶æ€</label>
                                <select class="form-select" name="status">
                                    <option value="published" {% if not article or article.status == 'published' %}selected{% endif %}>ç«‹å³å‘å¸ƒ</option>
                                    <option value="draft" {% if article and article.status == 'draft' %}selected{% endif %}>ä¿å­˜ä¸ºè‰ç¨¿</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">åˆ†ç±»</label>
                                <input type="text" class="form-control" name="category"
                                       value="{{ article.category if article else '' }}"
                                       placeholder="ä¾‹å¦‚ï¼šæŠ€æœ¯ã€æ•™ç¨‹ã€æ–°é—»">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">æ ‡ç­¾</label>
                                <input type="text" class="form-control" name="tags"
                                       value="{{ article.tags if article else '' }}"
                                       placeholder="å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”">
                                <small class="form-text text-muted">ä¾‹å¦‚ï¼šPython, Flask, Webå¼€å‘</small>
                            </div>

                            <hr>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>ä¿å­˜æ–‡ç« 
                                </button>
                                <a href="{{ url_for('admin_articles') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>è¿”å›åˆ—è¡¨
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// å°é¢å›¾ç‰‡ç›¸å…³å‡½æ•° - ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
function showCoverImagePicker() {
    console.log('âœ… showCoverImagePicker è¢«è°ƒç”¨');
    // ä»APIè·å–æ‰€æœ‰å›¾ç‰‡
    fetch('/api/images')
        .then(response => response.json())
        .then(images => {
            showImagePickerModal(images);
        })
        .catch(error => {
            console.error('Error fetching images:', error);
            alert('åŠ è½½å›¾ç‰‡å¤±è´¥');
        });
}

function showImagePickerModal(images) {
    console.log('âœ… showImagePickerModal è¢«è°ƒç”¨ï¼Œå›¾ç‰‡æ•°é‡:', images.length);
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é€‰æ‹©å°é¢å›¾ç‰‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row" id="imagePickerGrid">
                        ${images.map(img => `
                            <div class="col-md-3 mb-3">
                                <div class="card ${img.filepath === document.getElementById('coverImageInput').value ? 'border-primary' : ''} selectable-image"
                                     data-url="/static/${img.filepath}"
                                     style="cursor: pointer;">
                                    <img src="/static/${img.filepath}" class="card-img-top" alt="${img.title}" style="height: 150px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <p class="card-title small mb-0" title="${img.title}">${img.title.substring(0, 15)}${img.title.length > 15 ? '...' : ''}</p>
                                    </div>
                                    ${img.filepath === document.getElementById('coverImageInput').value ? '<div class="selected-badge"><i class="fas fa-check-circle text-primary"></i></div>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    `;

    // æ·»åŠ é€‰æ‹©é€»è¾‘
    modal.addEventListener('click', function(e) {
        const card = e.target.closest('.selectable-image');
        if (card) {
            const url = card.dataset.url;
            console.log('âœ… é€‰æ‹©äº†å›¾ç‰‡:', url);
            console.log('âœ… å‡†å¤‡è°ƒç”¨ setCoverImage');
            try {
                setCoverImage(url);
                console.log('âœ… setCoverImage è°ƒç”¨å®Œæˆ');
                console.log('âœ… å‡†å¤‡å…³é—­æ¨¡æ€æ¡†');
                // å»¶è¿Ÿå…³é—­æ¨¡æ€æ¡†ï¼Œè®© setCoverImage å®Œæˆ
                setTimeout(function() {
                    bsModal.hide();
                }, 100);
                console.log('âœ… æ¨¡æ€æ¡†å…³é—­æŒ‡ä»¤å·²å‘é€');
            } catch (error) {
                console.error('âŒ é€‰æ‹©å›¾ç‰‡æ—¶å‡ºé”™:', error);
                alert('é€‰æ‹©å›¾ç‰‡æ—¶å‡ºé”™: ' + error.message);
            }
        }
    });

    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
}

function setCoverImage(url) {
    console.log('âœ… setCoverImage è¢«è°ƒç”¨:', url);
    const input = document.getElementById('coverImageInput');
    console.log('âœ… è·å–åˆ° input å…ƒç´ :', input);

    let saveValue;
    let displayUrl;

    // æ£€æŸ¥URLç±»å‹å¹¶ç›¸åº”å¤„ç†
    if (url.startsWith('data:image/')) {
        // Base64æ•°æ®URL - ç›´æ¥ä¿å­˜
        saveValue = url;
        displayUrl = url;
        console.log('âœ… æ£€æµ‹åˆ°Base64å›¾ç‰‡ï¼Œç›´æ¥ä¿å­˜');
    } else if (url.startsWith('/static/')) {
        // æœåŠ¡å™¨å›¾ç‰‡ - å»æ‰ /static/ å‰ç¼€ä¿å­˜
        saveValue = url.replace('/static/', '');
        displayUrl = url;
        console.log('âœ… æ£€æµ‹åˆ°æœåŠ¡å™¨å›¾ç‰‡ï¼Œå»æ‰ /static/ å‰ç¼€ä¿å­˜:', saveValue);
    } else {
        // å…¶ä»–æƒ…å†µ - å‡è®¾æ˜¯æ•°æ®åº“è·¯å¾„ï¼Œæ·»åŠ  /static/ å‰ç¼€æ˜¾ç¤º
        saveValue = url;
        displayUrl = `/static/${url}`;
        console.log('âœ… æ£€æµ‹åˆ°æ•°æ®åº“è·¯å¾„ï¼Œæ·»åŠ  /static/ å‰ç¼€æ˜¾ç¤º:', displayUrl);
    }

    input.value = saveValue;
    console.log('âœ… å·²ä¿å­˜åˆ°æ•°æ®åº“:', saveValue.substring(0, 100) + (saveValue.length > 100 ? '...' : ''));

    const selectorDiv = document.querySelector('.cover-image-selector');
    console.log('âœ… è·å–åˆ° selectorDiv:', selectorDiv);
    const currentCoverDiv = document.getElementById('currentCover');
    console.log('âœ… è·å–åˆ° currentCoverDiv:', currentCoverDiv);

    if (currentCoverDiv) {
        console.log('âœ… æ›´æ–°ç°æœ‰å°é¢é¢„è§ˆ');
        currentCoverDiv.querySelector('img').src = displayUrl;
    } else {
        console.log('âœ… åˆ›å»ºæ–°çš„å°é¢é¢„è§ˆ');
        const newCoverDiv = document.createElement('div');
        newCoverDiv.id = 'currentCover';
        newCoverDiv.className = 'current-cover mb-3';
        newCoverDiv.innerHTML = `
            <img src="${displayUrl}" alt="å½“å‰å°é¢" class="img-thumbnail" style="max-height: 200px;">
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCoverImage()">
                    <i class="fas fa-times me-1"></i>ç§»é™¤å°é¢
                </button>
            </div>
        `;
        selectorDiv.insertBefore(newCoverDiv, selectorDiv.firstChild);
    }
    console.log('âœ… setCoverImage æ‰§è¡Œå®Œæˆ');
}

function removeCoverImage() {
    console.log('âœ… removeCoverImage è¢«è°ƒç”¨');
    document.getElementById('coverImageInput').value = '';
    const currentCoverDiv = document.getElementById('currentCover');
    if (currentCoverDiv) {
        currentCoverDiv.remove();
    }
}

function uploadNewCoverImage() {
    console.log('âœ… uploadNewCoverImage è¢«è°ƒç”¨');
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            console.log('âœ… æ–‡ä»¶å·²é€‰æ‹©:', file.name, file.size);

            // ä¸¥æ ¼é™åˆ¶å›¾ç‰‡å¤§å°ä¸º500KB
            if (file.size > 500 * 1024) {
                alert('âŒ å°é¢å›¾ç‰‡è¿‡å¤§ï¼\n\nä¸Šä¼ æ–°å°é¢çš„å›¾ç‰‡å¿…é¡»å°äº 500KB\n\nğŸ’¡ å»ºè®®ï¼š\n1. ä½¿ç”¨å›¾ç‰‡ç¼–è¾‘å·¥å…·å‹ç¼©å›¾ç‰‡\n2. æˆ–ä½¿ç”¨"ä»å›¾ç‰‡åº“é€‰æ‹©"ä¸Šä¼ å¤§å›¾ç‰‡\n3. æˆ–å…ˆä¸Šä¼ åˆ°å›¾ç‰‡ç®¡ç†ï¼Œå†é€‰æ‹©');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('âœ… å›¾ç‰‡è¯»å–å®Œæˆï¼Œå‡†å¤‡è®¾ç½®å°é¢');
                setCoverImage(e.target.result);
            };
            reader.onerror = function(error) {
                console.error('âŒ å›¾ç‰‡è¯»å–å¤±è´¥:', error);
                alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}

document.addEventListener('DOMContentLoaded', function() {
    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'å¼€å§‹ç¼–å†™æ‚¨çš„æ–‡ç« ...\n\nğŸ’¡ æç¤ºï¼šä¸Šä¼ å¤§å›¾ç‰‡è¯·ä½¿ç”¨å›¾ç‰‡ç®¡ç†åŠŸèƒ½ï¼Œç„¶ååœ¨æ–‡ç« ä¸­æ’å…¥å›¾ç‰‡é“¾æ¥',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'script': 'sub'}, { 'script': 'super' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                [{ 'direction': 'rtl' }],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }],
                ['link', 'image', 'video'],
                ['clean']
            ]
        }
    });

    // è‡ªå®šä¹‰å›¾ç‰‡æ’å…¥å¤„ç†
    const toolbar = quill.getModule('toolbar');
    if (toolbar) {
        // è¦†ç›–é»˜è®¤çš„å›¾ç‰‡å¤„ç†
        toolbar.addHandler('image', function() {
            showImageUploadDialog();
        });
    } else {
        // å¦‚æœtoolbaræ¨¡å—ä¸å¯ç”¨ï¼Œå°è¯•ç›´æ¥ç»‘å®š
        document.querySelector('.ql-image').addEventListener('click', function(e) {
            e.preventDefault();
            showImageUploadDialog();
        });
    }

    function showImageUploadDialog() {
        const dialog = document.createElement('div');
        dialog.className = 'modal fade';
        dialog.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">æ’å…¥å›¾ç‰‡</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</label>
                            <input type="file" class="form-control" id="imageFileInput" accept="image/*">
                            <small class="form-text text-muted">å»ºè®®å°äº 500KBï¼Œæˆ–å…ˆä¸Šä¼ åˆ°å›¾ç‰‡ç®¡ç†</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æˆ–è¾“å…¥å›¾ç‰‡URL</label>
                            <input type="url" class="form-control" id="imageUrlInput" placeholder="https://example.com/image.jpg">
                            <small class="form-text text-muted">æ¨èï¼šä½¿ç”¨å¤–éƒ¨å›¾ç‰‡é“¾æ¥ï¼Œé¿å…æ–‡ç« è¿‡å¤§</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" id="insertImageBtn">æ’å…¥</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);

        const modal = new bootstrap.Modal(dialog);
        const insertBtn = dialog.querySelector('#insertImageBtn');

        insertBtn.addEventListener('click', function() {
            const fileInput = dialog.querySelector('#imageFileInput');
            const urlInput = dialog.querySelector('#imageUrlInput');

            if (fileInput.files[0]) {
                const file = fileInput.files[0];
                if (file.size > 500 * 1024) { // 500KB
                    alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼è¯·é€‰æ‹©å°äº 500KB çš„å›¾ç‰‡ï¼Œæˆ–ä½¿ç”¨å›¾ç‰‡ç®¡ç†åŠŸèƒ½ä¸Šä¼ å¤§å›¾ç‰‡');
                    return;
                }
                insertBase64Image(file);
            } else if (urlInput.value) {
                insertImageByUrl(urlInput.value);
            }

            modal.hide();
            dialog.remove();
        });

        modal.show();

        dialog.addEventListener('hidden.bs.modal', function() {
            dialog.remove();
        });
    }

    function insertBase64Image(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'image', e.target.result, 'user');
        };
        reader.readAsDataURL(file);
    }

    function insertImageByUrl(url) {
        const range = quill.getSelection(true);
        quill.insertEmbed(range.index, 'image', url, 'user');
    }

    // æ£€æŸ¥æ–‡ç« å†…å®¹ä¸­çš„å›¾ç‰‡å¤§å°
    function checkArticleImages() {
        const content = quill.root.innerHTML;
        const base64Matches = content.match(/data:image\/[^;]+;base64,[A-Za-z0-9+/=]+/g) || [];
        let totalSize = 0;

        for (const match of base64Matches) {
            const base64Data = match.split(',')[1];
            const decodedSize = base64Data.length * 3 / 4; // è¿‘ä¼¼è§£ç å¤§å°
            totalSize += decodedSize;

            if (decodedSize > 500 * 1024) { // 500KB
                alert('âš ï¸ æ£€æµ‹åˆ°è¿‡å¤§å›¾ç‰‡ï¼šå•ä¸ªå›¾ç‰‡è¶…è¿‡ 500KB\n\nå»ºè®®ï¼š\n1. ä½¿ç”¨å›¾ç‰‡ç®¡ç†åŠŸèƒ½ä¸Šä¼ å¤§å›¾ç‰‡\n2. åœ¨æ–‡ç« ä¸­æ’å…¥å›¾ç‰‡é“¾æ¥');
                return false;
            }
        }

        if (totalSize > 2 * 1024 * 1024) { // 2MB
            alert('âš ï¸ æ–‡ç« ä¸­å›¾ç‰‡æ€»å¤§å°è¶…è¿‡ 2MB\n\nå»ºè®®ä½¿ç”¨å¤–éƒ¨å›¾ç‰‡é“¾æ¥ä»¥å‡å°æ–‡ç« å¤§å°');
            return false;
        }

        return true;
    }

    document.getElementById('articleForm').addEventListener('submit', function(e) {
        const content = quill.root.innerHTML;
        document.getElementById('contentInput').value = content;

        if (quill.getText().trim().length === 0) {
            e.preventDefault();
            alert('è¯·è¾“å…¥æ–‡ç« å†…å®¹');
            return false;
        }

        if (!checkArticleImages()) {
            e.preventDefault();
            return false;
        }
    });

    // å®æ—¶ç›‘æ§å›¾ç‰‡æ’å…¥
    quill.on('text-change', function() {
        const content = quill.root.innerHTML;
        const base64Matches = content.match(/data:image\/[^;]+;base64,[A-Za-z0-9+/=]+/g) || [];
        if (base64Matches.length > 0) {
            let totalSize = 0;
            base64Matches.forEach(match => {
                const base64Data = match.split(',')[1];
                totalSize += base64Data.length * 3 / 4;
            });

            if (totalSize > 1024 * 1024) { // 1MB
                console.warn('æ–‡ç« å›¾ç‰‡æ€»å¤§å°è¶…è¿‡1MBï¼Œå¯èƒ½å½±å“æ€§èƒ½');
            }
        }
    });
});
</script>

<style>
.cover-image-selector {
    padding: 15px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    background-color: #f8f9fa;
}

.current-cover {
    text-align: center;
}

.current-cover img {
    max-width: 100%;
    border-radius: 8px;
}

.selectable-image {
    position: relative;
    transition: all 0.3s;
}

.selectable-image:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.selected-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

#imagePickerGrid .card {
    overflow: hidden;
}

#imagePickerGrid .card-img-top {
    transition: transform 0.3s;
}

#imagePickerGrid .card:hover .card-img-top {
    transform: scale(1.1);
}
</style>
{% endblock %}
