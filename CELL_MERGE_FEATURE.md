# 网格编辑器单元格合并功能说明

## 📋 功能概述

已为网格编辑器添加了单元格合并和取消合并功能，允许用户创建更大、更灵活的布局区域。

## ✨ 核心功能

### 1. 单元格选择 ✅
- **单击单元格**: 选择单个单元格
- **Ctrl/Cmd + 单击**: 多选单元格
- **选择状态**: 选中的单元格显示蓝色边框和✓标识

### 2. 合并单元格 ✅
- **功能**: 将2个或更多连续的单元格合并为一个大单元格
- **要求**: 选择的单元格必须形成连续的矩形区域
- **视觉标识**: 合并单元格显示特殊样式和尺寸标识

### 3. 取消合并 ✅
- **功能**: 将合并的单元格拆分回独立单元格
- **支持**: 可以从合并区域的任意单元格取消合并

## 🔧 技术实现

### 数据结构
```javascript
gridData = {
    columns: 3,
    rowHeight: 100,
    rows: 3,
    cells: {},           // { 'row-col': elementData }
    mergedCells: {       // 新增：合并单元格信息
        'row-col': {
            rowSpan: 2,      // 跨行数
            colSpan: 2,      // 跨列数
            masterCell: 'row-col',  // 主单元格标识
            cells: ['row-col', 'row-col', ...]  // 所有参与的单元格
        }
    }
}
```

### 后端存储
- **保存位置**: ContentBlock的content字段中
- **保存字段**:
  - `merged_cell`: 标记是否为合并单元格
  - `row_span`: 跨行数
  - `col_span`: 跨列数

### API更新
1. **GET `/api/admin/pages/{id}/grid-layout`**
   - 返回合并单元格信息

2. **POST `/api/admin/pages/{id}/grid-layout`**
   - 接收并保存mergedCells数据

## 🎨 用户界面

### 工具栏按钮
位置: 网格设置区域
- **合并单元格** (绿色按钮)
  - 图标: `fas fa-compress`
  - 状态: 选择2个以上单元格时启用
  - 点击: 合并选中的单元格

- **取消合并** (黄色按钮)
  - 图标: `fas fa-expand`
  - 状态: 选中合并单元格时启用
  - 点击: 取消合并选中的单元格

### 视觉样式
- **选中状态**: 
  - 蓝色边框 (`#0d6efd`)
  - 浅蓝背景 (`#e7f3ff`)
  - ✓ 圆形标识

- **合并单元格**:
  - 灰色边框 (`#6c757d`)
  - 渐变背景 (`#f8f9fa` → `#e9ecef`)
  - 右下角尺寸标识 (如: `2x2`)

## 📝 使用步骤

### 合并单元格
1. **选择单元格**
   ```
   [A][B][C]
   [D][E][F]  ← 选择 B, C, E, F
   [G][H][I]
   ```

2. **点击合并按钮**
   - 按钮变为可用状态（绿色高亮）
   - 点击"合并单元格"

3. **查看结果**
   ```
   [A]  [  B&C  ]  (合并)
   [D]  [  E&F  ]  (合并)
   [G]  [H][I]
   ```

### 取消合并
1. **选择合并单元格**
   - 点击任意已合并的单元格
   - 按钮变为可用状态（黄色高亮）

2. **点击取消合并按钮**
   - 单元格拆分回原始状态

## ⚙️ 操作规则

### 合并规则
✅ **允许的操作**:
- 选择2个或更多连续的单元格
- 选择形成矩形的单元格区域
- 合并包含元素的单元格（保留元素）

❌ **禁止的操作**:
- 选择非连续单元格
- 选择非矩形区域
- 选择已合并的单元格
- 选择超过网格边界的单元格

### 取消合并规则
✅ **允许的操作**:
- 选择合并单元格的主单元格
- 选择合并单元格的从单元格
- 取消任意大小的合并区域

## 🎯 使用场景

### 场景1: 创建大标题区域
```
[H1 标  题 区域    ]
[副标题/描述文本  ]
[内容A][内容B][内容C]
```
**操作**: 合并第一行的所有单元格

### 场景2: 创建侧边栏布局
```
[主内容      ][侧边栏]
[主内容      ][侧边栏]
[主内容      ][侧边栏]
```
**操作**: 合并右侧两列

### 场景3: 创建全宽横幅
```
[          横幅图像          ]
[文本A][文本B][文本C][文本D]
```
**操作**: 合并第一行的所有单元格

## 🔍 测试建议

### 功能测试
1. **选择测试**
   - [ ] 单选单元格
   - [ ] Ctrl/Cmd多选
   - [ ] 清除选择
   - [ ] 选择状态显示正确

2. **合并测试**
   - [ ] 合并2个单元格
   - [ ] 合并3x3区域
   - [ ] 合并包含元素的单元格
   - [ ] 保存并重新加载
   - [ ] 前台显示正确

3. **取消合并测试**
   - [ ] 从主单元格取消合并
   - [ ] 从从单元格取消合并
   - [ ] 保存并重新加载

4. **边界测试**
   - [ ] 网格边界检查
   - [ ] 错误提示显示
   - [ ] 重置功能

### 兼容性测试
- [ ] 与拖拽功能兼容
- [ ] 与元素编辑兼容
- [ ] 与保存功能兼容
- [ ] 与多语言兼容
- [ ] 与响应式布局兼容

## 🚨 注意事项

### 数据完整性
- 合并后除主单元格外，其他单元格的内容被清空
- 取消合并不会恢复已删除的内容
- 保存前请确保合并设置正确

### 性能考虑
- 合并单元格会增加DOM复杂度
- 大量合并单元格可能影响渲染性能
- 建议合理使用合并功能

### 浏览器兼容性
- 需要支持CSS Grid的现代浏览器
- IE11及以下版本不支持

## 📊 技术细节

### CSS Grid实现
```css
/* 合并单元格使用CSS Grid的span属性 */
.merged-cell {
    grid-row: {start} / span {rowSpan};
    grid-column: {start} / span {colSpan};
}
```

### JavaScript核心函数
| 函数名 | 功能 |
|--------|------|
| `renderGrid()` | 渲染网格（包含合并单元格） |
| `isCellPartOfMerge()` | 检查单元格是否属于合并区域 |
| `addCellClickHandler()` | 添加单元格点击选择功能 |
| `canMergeSelectedCells()` | 验证是否可以合并选中的单元格 |
| `mergeSelectedCells()` | 执行合并操作 |
| `unmergeSelectedCells()` | 执行取消合并操作 |
| `updateMergeButtons()` | 更新按钮状态 |

## 🎉 总结

单元格合并功能大大增强了网格编辑器的灵活性：
- **布局灵活**: 可创建任意大小的区域
- **操作简单**: 直观的点击选择和合并
- **数据安全**: 自动处理内容保存和加载
- **视觉清晰**: 明确的视觉标识和状态反馈

---
**开发日期**: 2025-10-30  
**版本**: v2.0.0+  
**相关文件**: 
- `templates/admin/dynamic_page_editor.html` (前端)
- `app.py` (后端API)
